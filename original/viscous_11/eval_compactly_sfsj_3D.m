function [sf,sj_compact]=...
    eval_compactly_sfsj_3D(sf,sj_compact,isj,iSparse,...
    col_placement,...
    w1,w2,w3,dx,dy,dz,n1,n2,con,cono,...
    conx,cony,conz,conxx,conyy,conzz,phi,phixx,phiyy,phizz,...
    gbasis,dt,diff,T,chi)

cont=(con-cono)/dt;

for i=1:1:64
    sf(gbasis(i))=sf(gbasis(i))-w1*w2*w3*dx*dy*dz*...
        (cont*phi(i)-diff*T*phi(i)*(-1.0/(con^2.0)...
        +(1./10.)*(1-con)^-2.0)*(conx^2.0+...
        cony^2.0+conz^2.0)-diff*T*phi(i)*...
        (1/con+(1./10.)*(1./(1.-con))-2*chi)*...
        (conxx+conyy+conzz)+(conxx+conyy+conzz)*...
        (phixx(i)+phiyy(i)+phizz(i)));
    for j=1:1:64
%         isj_val=gbasis(i)+gbasis(j)/col_placement;
%         index=find(isj==isj_val);
        index=iSparse(gbasis(i),gbasis(j));
        if index==0
            error('BAD ERROR FOUND')
        end
        sj_compact(index)=sj_compact(index)+w1...
            *w2*w3*dx*dy*dz*...
            (phi(i)*phi(j)/dt-diff*T*phi(i)*((2*phi(j)...
            /(con^3.0)+2*phi(j)/(10*(1-con)^3))*...
            (conx^2.0+cony^2.0+conz^2.0)+(-1/con^2.0+...
            1/(10*(1-con)^2.0))...
            *(2*conx*phi(j)+2*cony*phi(j)+2*conz*phi(j)))-diff*T*phi(i)...
            *((-phi(j)/con^2.0+phi(j)/(10*(1-con)^2))*...
            (conxx+conyy+conzz)+(1/con+1/(10*(1-con))-2*chi)...
            *(phixx(j)+phiyy(j)+phizz(j)))+(phixx(j)+phiyy(j)+phizz(j))...
            *(phixx(i)+phiyy(i)+phizz(i)));
    end
end

end